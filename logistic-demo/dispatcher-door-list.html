<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>调度员 · 库门列表</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '库门列表 · 调度员',
      titleIcon: 'fas fa-door-open',
      role: 'dispatcher',
      activeNav: 'operate',
      content: `
        <div class="px-5 py-6 pb-28 bg-gray-50/50 min-h-screen">
          
          <!-- Stats Header -->
          <div class="grid grid-cols-3 gap-3 mb-6" id="statsHeader">
             <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 flex flex-col items-center justify-center h-20">
                 <span class="text-[10px] text-gray-400 mb-1">全部库门</span>
                 <span class="text-xl font-bold text-gray-800" id="valTotal">--</span>
             </div>
             <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 flex flex-col items-center justify-center h-20">
                 <span class="text-[10px] text-gray-400 mb-1">暂停中</span>
                 <span class="text-xl font-bold text-orange-500" id="valPaused">--</span>
             </div>
             <div class="bg-white rounded-2xl p-3 shadow-sm border border-gray-100 flex flex-col items-center justify-center h-20">
                 <span class="text-[10px] text-gray-400 mb-1">限制中</span>
                 <span class="text-xl font-bold text-red-500" id="valLimited">--</span>
             </div>
          </div>

          <!-- Tabs -->
          <div class="bg-gray-200/60 p-1 rounded-xl flex items-center mb-5 relative">
            <div id="tabIndicator" class="absolute top-1 bottom-1 left-1 w-[calc(33.33%-4px)] bg-white rounded-lg shadow-sm transition-all duration-300 ease-out"></div>
            <button id="tabAll" class="flex-1 relative z-10 py-2 text-xs font-bold text-gray-700 transition-colors">全部</button>
            <button id="tabPaused" class="flex-1 relative z-10 py-2 text-xs font-bold text-gray-500 transition-colors">暂停</button>
            <button id="tabLimited" class="flex-1 relative z-10 py-2 text-xs font-bold text-gray-500 transition-colors">限制</button>
          </div>

          <div id="list" class="space-y-3"></div>
        </div>
      `
    });
  </script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || 'all';
    
    let appData = null;
    function loadData(){
        const url = new URL('app-data.json', document.baseURI).href;
        if(location.protocol === 'file:'){
            appData = (window.APP_DATA_FALLBACK || {}); 
            return Promise.resolve(appData);
        }
        return fetch(url).then(r => r.json()).then(d => { appData = d; return d; }).catch(e=>{ console.error(e); return {}; });
    }

    let doors = [];
    let currentFilter = initialFilter;

    function getDuration(timestamp){
      if(!timestamp) return '';
      const nowTime = new Date('2025-12-02T09:30:00').getTime(); 
      const startTime = new Date(timestamp).getTime();
      const diff = Math.max(0, nowTime - startTime);
      
      const minutes = Math.floor(diff / 60000);
      if(minutes < 60) return `${minutes}m`;
      const hours = Math.floor(minutes / 60);
      const mins = minutes % 60;
      return `${hours}h ${mins}m`;
    }

    function render(){
      if(!appData) return;
      doors = appData.doors || [];

      // Update Stats
      const total = doors.length;
      const paused = doors.filter(d => d.status === 'paused').length;
      const limited = doors.filter(d => d.status === 'limited').length;
      
      document.getElementById('valTotal').textContent = total;
      document.getElementById('valPaused').textContent = paused;
      document.getElementById('valLimited').textContent = limited;

      // Mapping filter
      let filtered = doors;
      if(currentFilter === 'paused') filtered = doors.filter(d => d.status === 'paused');
      else if(currentFilter === 'limited') filtered = doors.filter(d => d.status === 'limited');
      
      // Sort: Paused/Limited first, then by ID
      filtered.sort((a,b) => {
          const score = s => (s==='paused'?3 : s==='limited'?2 : s==='working'?1 : 0);
          return (score(b.status) - score(a.status)) || a.id.localeCompare(b.id);
      });

      const list = document.getElementById('list');
      list.innerHTML = '';
      
      if(filtered.length===0){ 
          list.innerHTML = `<div class='py-12 text-center text-sm text-gray-400 flex flex-col items-center opacity-60'><i class="fas fa-door-closed text-4xl text-gray-300 mb-3"></i>暂无相关库门</div>`; 
          return; 
      }
      
      filtered.forEach(d=>{
        const item = document.createElement('div');
        item.className = 'bg-white rounded-2xl p-4 shadow-[0_2px_8px_rgba(0,0,0,0.04)] border border-gray-100 active:scale-[0.99] transition-all cursor-pointer';
        
        let statusBadge = '';
        let statusText = '';
        let statusDot = '';
        
        if(d.status==='working'){ 
             statusBadge='bg-green-50 text-green-700'; 
             statusText='启用中'; 
             statusDot='bg-green-500';
         } else if(d.status==='paused'){ 
             statusBadge='bg-orange-50 text-orange-700'; 
             statusText='暂停'; 
             statusDot='bg-orange-500';
         } else if(d.status==='limited'){ 
             statusBadge='bg-red-50 text-red-700'; 
             statusText='限制'; 
             statusDot='bg-red-500';
         } else { 
             statusBadge='bg-gray-50 text-gray-600'; 
             statusText='已关闭'; 
             statusDot='bg-gray-400';
         }

         const oversizeTag = d.supportsOversize ? 
             `<div class="px-1.5 py-0.5 rounded text-[10px] font-bold bg-indigo-100 text-indigo-700 border border-indigo-200 ml-2">支持大件</div>` : '';
         
         let durationHtml = '';
         if((d.status === 'paused' || d.status === 'limited') && d.statusTimestamp){
            const duration = getDuration(d.statusTimestamp);
            durationHtml = `
              <div class="mt-3 pt-3 border-t border-gray-50 flex items-center justify-between text-xs">
                 <span class="text-gray-500 font-medium">持续时间</span>
                 <span class="font-bold text-gray-700 font-mono bg-gray-100 px-2 py-0.5 rounded">${duration}</span>
              </div>`;
         }

         item.innerHTML = `
           <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                 <div class="w-10 h-10 rounded-xl bg-gray-100 flex items-center justify-center text-gray-900 font-bold text-sm border border-gray-200 shadow-sm">
                    ${d.id}
                 </div>
                 ${oversizeTag}
              </div>
              <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-bold ${statusBadge}">
                 <div class="w-1.5 h-1.5 rounded-full ${statusDot}"></div>
                 ${statusText}
              </div>
           </div>
           
           <div class="grid grid-cols-2 gap-4">
              <div class="bg-gray-50/80 rounded-xl p-2.5 flex flex-col">
                 <span class="text-[10px] text-gray-500 font-medium mb-1">当前排队</span>
                 <div class="flex items-center gap-2">
                    <i class="fas fa-users text-indigo-400 text-xs"></i>
                    <span class="text-sm font-bold text-gray-900">${d.queue}</span>
                 </div>
              </div>
              <div class="bg-gray-50/80 rounded-xl p-2.5 flex flex-col">
                 <span class="text-[10px] text-gray-500 font-medium mb-1">当前作业</span>
                 <div class="flex items-center gap-2 justify-between">
                    <span class="text-sm font-bold text-gray-900 truncate">${d.currentTask || '--'}</span>
                    <i class="fas fa-truck-loading text-indigo-400 text-xs"></i>
                 </div>
              </div>
           </div>
 
           ${durationHtml}
         `;
        item.onclick = ()=>{ window.location.href = `dispatcher-door-detail.html?door=${d.id}`; };
        list.appendChild(item);
      });
    }

    function setActiveTabs(){
      const indicator = document.getElementById('tabIndicator');
      const tabs = ['tabAll', 'tabPaused', 'tabLimited'];
      const filters = ['all', 'paused', 'limited'];
      
      const index = filters.indexOf(currentFilter);
      indicator.style.transform = `translateX(${index * 100}%)`;

      tabs.forEach((id, i) => {
          const btn = document.getElementById(id);
          if(i === index){
              btn.classList.remove('text-gray-500');
              btn.classList.add('text-gray-800');
          } else {
              btn.classList.remove('text-gray-800');
              btn.classList.add('text-gray-500');
          }
      });
    }

    document.getElementById('tabAll').onclick = ()=>{ currentFilter='all'; setActiveTabs(); render(); };
    document.getElementById('tabPaused').onclick = ()=>{ currentFilter='paused'; setActiveTabs(); render(); };
    document.getElementById('tabLimited').onclick = ()=>{ currentFilter='limited'; setActiveTabs(); render(); };

    setActiveTabs();
    loadData().then(render);
  </script>
</body>
</html>