<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>操作员 · 卸车任务</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .step-line { position: absolute; top: 50%; left: 0; right: 0; height: 2px; background: #e5e7eb; z-index: 0; transform: translateY(-50%); }
    .step-item { position: relative; z-index: 10; background: white; padding: 0 4px; }
  </style>
</head>
<body class="bg-gray-50">
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '卸车任务 · 操作员',
      titleIcon: 'fas fa-dolly',
      role: 'operator',
      activeNav: 'operate',
      content: `
        <div class="flex flex-col h-full relative">
          <!-- Steps Header -->
          <div class="bg-white px-6 py-4 shadow-sm z-10">
            <div class="relative flex items-center justify-between text-sm font-medium text-gray-500">
              <div class="step-line"></div>
              <div id="stepStart" class="step-item flex flex-col items-center gap-1 transition-colors duration-300 text-indigo-600">
                <div class="w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-sm"><i class="fas fa-play text-xs"></i></div>
                <span class="text-xs">准备</span>
              </div>
              <div id="stepRecord" class="step-item flex flex-col items-center gap-1 transition-colors duration-300">
                <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center border border-gray-200"><i class="fas fa-dolly text-xs"></i></div>
                <span class="text-xs">卸车中</span>
              </div>
              <div id="stepFinish" class="step-item flex flex-col items-center gap-1 transition-colors duration-300">
                <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center border border-gray-200"><i class="fas fa-flag-checkered text-xs"></i></div>
                <span class="text-xs">完成</span>
              </div>
            </div>
          </div>

          <!-- Main Content Area -->
          <div class="flex-1 overflow-y-auto bg-gray-50 pb-32 scrollbar-hide" id="mainScroll">
            
            <!-- Phase 1: Preparation (Merged Input & Verify) -->
            <div id="prepPhase" class="hidden h-full flex flex-col p-4">
              <div class="bg-white rounded-2xl shadow-sm p-6 mb-4">
                 <div class="flex items-center gap-3 mb-6">
                   <div class="w-10 h-10 rounded-full bg-indigo-50 flex items-center justify-center text-indigo-600">
                     <i class="fas fa-clipboard-check text-lg"></i>
                   </div>
                   <div>
                     <h2 class="text-lg font-bold text-gray-800">任务准备</h2>
                     <p class="text-xs text-gray-500">确认任务信息并核对车辆</p>
                   </div>
                 </div>

                 <!-- Task ID Input -->
                 <div class="mb-6">
                   <label class="block text-sm font-medium text-gray-700 mb-2">任务单号</label>
                   <div class="relative">
                     <input type="text" id="inputTaskId" class="w-full pl-4 pr-12 py-3 border border-gray-200 rounded-xl text-base focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="扫描或输入任务号" value="" oninput="checkTaskInfo()">
                     <button class="absolute right-2 top-1/2 -translate-y-1/2 w-8 h-8 rounded-lg bg-gray-50 text-gray-400 flex items-center justify-center hover:text-indigo-600 transition-colors" onclick="scanTask()">
                       <i class="fas fa-qrcode"></i>
                     </button>
                   </div>
                 </div>

                 <!-- Task Info Card (Hidden until Task ID is valid) -->
                 <div id="taskInfoCard" class="hidden mb-6 bg-gray-50 rounded-xl p-4 border border-gray-100">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <div class="text-xs text-gray-400 mb-1">作业库门</div>
                        <div class="font-bold text-gray-800" id="verifyDoor">--</div>
                      </div>
                      <div>
                        <div class="text-xs text-gray-400 mb-1">预报车牌</div>
                        <div class="font-bold text-gray-800" id="verifyExpPlate">--</div>
                      </div>
                    </div>
                    
                    <!-- Plate Verification -->
                    <div class="pt-4 border-t border-gray-200">
                      <label class="block text-sm font-medium text-gray-700 mb-2">校对车牌 (后4位)</label>
                      <div class="flex gap-2">
                        <input type="text" id="plateInput" class="flex-1 py-3 px-4 border border-gray-200 rounded-xl text-center text-lg font-bold tracking-[0.2em] focus:ring-2 focus:ring-indigo-500 outline-none uppercase bg-white placeholder-gray-300" placeholder="XXXX" maxlength="4">
                      </div>
                      <div id="verifyError" class="hidden mt-2 text-xs text-red-500 flex items-center">
                        <i class="fas fa-circle-exclamation mr-1"></i> 车牌号不一致
                      </div>
                    </div>
                 </div>

                 <button id="btnStart" disabled class="w-full py-3.5 bg-indigo-600 text-white rounded-xl font-bold text-base shadow-lg shadow-indigo-200 active:scale-[0.98] transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none" onclick="doVerify()">
                   <i class="fas fa-play mr-2 text-xs"></i> 开始卸车
                 </button>
              </div>
            </div>

            <!-- Phase 3: Unloading (Original Logic) -->
            <div id="unloadingPhase" class="hidden p-4">
              <!-- Progress Info -->
              <div id="topProgress" class="bg-indigo-600 rounded-2xl p-4 mb-4 text-white shadow-lg shadow-indigo-200">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center backdrop-blur-sm"><i class="fas fa-chart-pie"></i></div>
                    <div>
                      <div class="text-xs text-indigo-100 opacity-80">当前进度</div>
                      <div class="text-sm font-bold" id="topProgText">--</div>
                    </div>
                  </div>
                  <div class="text-xs font-mono bg-white/20 px-2 py-1 rounded text-white backdrop-blur-sm" id="topTaskId">--</div>
                </div>
                <div class="h-1.5 bg-black/20 rounded-full overflow-hidden">
                    <div class="h-full bg-white/90 rounded-full w-1/3"></div> <!-- Mock progress bar -->
                </div>
              </div>

              <!-- Records List -->
              <div id="recordsContainer" class="space-y-3 pb-6">
                 <div id="emptyState" class="hidden flex flex-col items-center justify-center py-12 text-gray-400">
                    <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3 text-2xl"><i class="fas fa-clipboard-list"></i></div>
                    <p class="text-sm">暂无卸车记录</p>
                    <p class="text-xs mt-1">点击底部按钮添加记录</p>
                 </div>
                 <div id="recordsList" class="space-y-3"></div>
              </div>
              
              <!-- Finish Card -->
              <div id="finishCard" class="hidden bg-white rounded-2xl shadow-sm p-6"></div>
            </div>
          </div>

          <!-- Bottom Action Bar (Fixed) -->
          <div id="bottomBar" class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-8px_30px_rgba(0,0,0,0.08)] border-t border-gray-100 p-3 pb-6 z-40 transition-transform duration-300 translate-y-full">
            <!-- Content rendered by JS -->
          </div>
          
          <!-- Oversize Supervision Panel -->
          <div id="oversizePanel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-end justify-center transition-opacity duration-300">
            <div class="bg-white rounded-t-2xl w-full max-h-[85vh] overflow-y-auto shadow-2xl transform transition-transform duration-300 translate-y-full">
              <div class="sticky top-0 bg-white z-10 px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                 <div class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-user-shield text-indigo-600 mr-2"></i>大件监护申请</div>
                 <button onclick="closeOversizePanel()" class="w-8 h-8 rounded-full bg-gray-50 text-gray-400 flex items-center justify-center hover:bg-gray-100"><i class="fas fa-times"></i></button>
              </div>
              
              <div class="p-5 space-y-5">
                <div class="bg-gray-50 rounded-xl p-4 grid grid-cols-2 gap-4 text-sm border border-gray-100">
                   <div>
                     <div class="text-xs text-gray-500 mb-1">任务号</div>
                     <div class="font-bold text-gray-800 font-mono" id="osTaskId">--</div>
                   </div>
                   <div>
                     <div class="text-xs text-gray-500 mb-1">库门</div>
                     <div class="font-bold text-gray-800" id="osDoor">--</div>
                   </div>
                   <div class="col-span-2 pt-2 border-t border-gray-200">
                     <div class="text-xs text-gray-500 mb-1">车牌号</div>
                     <div class="font-bold text-gray-800 text-lg" id="osPlate">--</div>
                   </div>
                </div>
                
                <div>
                  <div class="text-sm font-bold text-gray-800 mb-3 flex items-center">选择监护主管 <span class="text-red-500 ml-1">*</span></div>
                  <div class="space-y-3">
                    <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors [&:has(:checked)]:border-indigo-500 [&:has(:checked)]:bg-indigo-50 [&:has(:checked)]:shadow-sm">
                      <input type="radio" name="supervisor" value="王主管" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500" checked>
                      <div class="ml-3">
                        <div class="text-sm font-bold text-gray-900">王主管</div>
                        <div class="text-xs text-green-600 flex items-center mt-0.5"><i class="fas fa-circle text-[8px] mr-1"></i> 现场一组 · 在线</div>
                      </div>
                    </label>
                    <label class="flex items-center p-3 border border-gray-200 rounded-xl cursor-pointer hover:bg-indigo-50 transition-colors [&:has(:checked)]:border-indigo-500 [&:has(:checked)]:bg-indigo-50 [&:has(:checked)]:shadow-sm">
                      <input type="radio" name="supervisor" value="李主管" class="w-4 h-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                      <div class="ml-3">
                        <div class="text-sm font-bold text-gray-900">李主管</div>
                        <div class="text-xs text-orange-500 flex items-center mt-0.5"><i class="fas fa-clock text-[8px] mr-1"></i> 现场二组 · 忙碌</div>
                      </div>
                    </label>
                  </div>
                </div>

                <div>
                  <div class="text-sm font-bold text-gray-800 mb-3">监护说明 (可选)</div>
                  <textarea id="osReason" class="w-full px-4 py-3 border border-gray-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none bg-gray-50 focus:bg-white transition-colors" rows="3" placeholder="请输入需要监护的具体情况..."></textarea>
                </div>

                <button class="w-full py-4 rounded-xl bg-indigo-600 text-white font-bold text-lg shadow-lg shadow-indigo-200 active:scale-[0.98] transition-transform" onclick="submitOversize()">提交申请</button>
              </div>
            </div>
          </div>

          <!-- Confirm Modal -->
           <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-6 backdrop-blur-sm transition-all">
            <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-2xl transform scale-100 transition-transform">
              <div class="w-12 h-12 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center mb-4 mx-auto">
                <i class="fas fa-exclamation-triangle text-xl"></i>
              </div>
              <div class="text-lg font-bold text-gray-800 mb-2 text-center">车牌不一致</div>
              <div class="text-sm text-gray-500 mb-6 text-center leading-relaxed">
                预报车牌 <span class="font-bold text-gray-800" id="modalExpPlate">--</span><br>
                录入车牌 <span class="font-bold text-red-500" id="modalActPlate">--</span><br>
                <span class="text-xs mt-2 block">确认要继续卸车吗？</span>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <button class="py-2.5 rounded-xl bg-gray-100 text-gray-600 font-medium hover:bg-gray-200 transition-colors" onclick="closeConfirmModal()">取消</button>
                <button class="py-2.5 rounded-xl bg-orange-500 text-white font-medium shadow-lg shadow-orange-200 hover:bg-orange-600 transition-colors" onclick="confirmCheck()">确认继续</button>
              </div>
            </div>
          </div>
        </div>
      `
    });
  </script>

  <script>
    function qs(name){ const u=new URLSearchParams(window.location.search); return u.get(name); }
    let taskId = qs('task_id') || '';
    const refresh = qs('refresh')==='true';
    
    // Mock Data
    const MOCK_DATA = {
        plate: '苏A 66888',
        door: 'W-03'
    };

    function addLooseRecord(){ window.location.href = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&type=loose'; }
    function addTrayRecord(){ window.location.href = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&type=tray'; }
    function backDetail(){ 
        if(taskId) window.location.href = 'operator-task-detail.html?task_id='+encodeURIComponent(taskId); 
        else window.history.back();
    }

    // State Management: prep -> unloading -> finished
    function getState(){ 
        try{ 
            const s=localStorage.getItem('unloadState:'+taskId); 
            if(s) return s;
            // Initial state logic
            if(!taskId) return 'prep';
            return 'prep'; 
        }catch(e){ return 'prep'; } 
    }
    function setState(s){ 
        if(taskId) try{ localStorage.setItem('unloadState:'+taskId, s); }catch(e){} 
        applyState(s); 
    }

    function applyState(s){
      // Update Steps UI
      const setStep = (id, active, completed) => {
        const el = document.getElementById(id);
        const iconDiv = el.querySelector('div');
        const text = el.querySelector('span');
        if(active){
          iconDiv.className = 'w-8 h-8 rounded-full bg-indigo-600 text-white flex items-center justify-center shadow-lg ring-4 ring-indigo-50 transition-all';
          text.className = 'text-xs font-bold text-indigo-700';
        } else if(completed) {
          iconDiv.className = 'w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center border border-indigo-200';
          text.className = 'text-xs font-medium text-indigo-600';
        } else {
          iconDiv.className = 'w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center border border-gray-200';
          text.className = 'text-xs text-gray-400';
        }
      };

      const isPrep = s==='prep';
      const isWork = s==='unloading';
      const isDone = s==='finished';

      setStep('stepStart', isPrep, !isPrep);
      setStep('stepRecord', isWork, isDone);
      setStep('stepFinish', isDone, false);

      // Toggle Containers
      document.getElementById('prepPhase').classList.toggle('hidden', s!=='prep');
      document.getElementById('unloadingPhase').classList.toggle('hidden', s!=='unloading' && s!=='finished');
      
      // Sub-containers in Unloading Phase
      if(s==='unloading' || s==='finished') {
          document.getElementById('recordsContainer').classList.toggle('hidden', s!=='unloading');
          document.getElementById('finishCard').classList.toggle('hidden', s!=='finished');
          document.getElementById('topProgress').classList.toggle('hidden', s!=='unloading');
      }

      // Bottom Bar
      renderBottomBar(s);

      // Specific inits
      if(s==='prep') {
          if(taskId) {
             document.getElementById('inputTaskId').value = taskId;
             checkTaskInfo();
          }
      }
      if(s==='unloading') { updateProgress(); renderRecords(); }
      if(s==='finished') renderFinishContent();
    }

    function renderBottomBar(s){
      const bar = document.getElementById('bottomBar');
      
      if(s==='prep') {
          bar.classList.add('translate-y-full'); 
          return;
      }
      
      bar.classList.remove('translate-y-full');
      // ... rest is same
      if(s==='unloading'){
        bar.innerHTML = `
            <div class="grid grid-cols-5 gap-2">
              <button onclick="backDetail()" class="flex flex-col items-center justify-center gap-1 py-2 rounded-xl text-gray-500 hover:bg-gray-50 active:bg-gray-100 transition-colors">
                <div class="w-8 h-8 rounded-full bg-gray-50 flex items-center justify-center mb-0.5"><i class="fas fa-arrow-left text-gray-600"></i></div>
                <span class="text-[10px] font-medium">返回</span>
              </button>
              
              <button onclick="addTrayRecord()" class="flex flex-col items-center justify-center gap-1 py-2 rounded-xl text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mb-0.5"><i class="fas fa-box text-indigo-600"></i></div>
                <span class="text-[10px] font-medium">整托</span>
              </button>

              <button onclick="addLooseRecord()" class="flex flex-col items-center justify-center gap-1 py-2 rounded-xl text-indigo-600 hover:bg-indigo-50 active:bg-indigo-100 transition-colors">
                <div class="w-8 h-8 rounded-full bg-indigo-100 flex items-center justify-center mb-0.5"><i class="fas fa-boxes text-indigo-600"></i></div>
                <span class="text-[10px] font-medium">散货</span>
              </button>

              <button onclick="openOversizePanel()" class="flex flex-col items-center justify-center gap-1 py-2 rounded-xl text-orange-600 hover:bg-orange-50 active:bg-orange-100 transition-colors">
                <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center mb-0.5"><i class="fas fa-user-shield text-orange-600"></i></div>
                <span class="text-[10px] font-medium">监护</span>
              </button>

              <button onclick="gotoFinish()" class="flex flex-col items-center justify-center gap-1 py-2 rounded-xl text-emerald-600 hover:bg-emerald-50 active:bg-emerald-100 transition-colors">
                <div class="w-8 h-8 rounded-full bg-emerald-100 flex items-center justify-center mb-0.5"><i class="fas fa-check text-emerald-600"></i></div>
                <span class="text-[10px] font-medium">完成</span>
              </button>
            </div>
        `;
      } else if(s==='finished'){
        bar.innerHTML = `
          <div class="flex gap-3">
              <button class="flex-1 py-3 rounded-xl bg-gray-100 text-gray-600 font-bold hover:bg-gray-200 active:scale-[0.98] transition-transform" onclick="cancelFinish()">
                <i class="fas fa-undo mr-2"></i>返回修改
              </button>
              <button id="btnConfirmFinish" class="flex-1 py-3 rounded-xl bg-indigo-600 text-white font-bold shadow-lg shadow-indigo-200 active:scale-[0.98] transition-transform flex items-center justify-center disabled:opacity-50 disabled:grayscale" disabled>
                <i class="fas fa-check-double mr-2"></i>确认完成
              </button>
          </div>
        `;
        setTimeout(bindFinishButton, 100);
      }
    }

    // Actions
    function scanTask(){
       scanOverlay({ text:'扫描任务单号...', duration: 1000, onDone: function(){
           const mock = 'TN202405' + Math.floor(Math.random()*100000);
           document.getElementById('inputTaskId').value = mock;
           checkTaskInfo();
       }});
    }

    function checkTaskInfo(){
       const val = document.getElementById('inputTaskId').value;
       const card = document.getElementById('taskInfoCard');
       const btn = document.getElementById('btnStart');
       
       if(val && val.length > 5){
           // Simulate fetching info
           document.getElementById('verifyDoor').textContent = MOCK_DATA.door;
           document.getElementById('verifyExpPlate').textContent = MOCK_DATA.plate;
           card.classList.remove('hidden');
           taskId = val; // update global
           
           // Check if plate is already entered
           const plateVal = document.getElementById('plateInput').value;
           btn.disabled = !(plateVal && plateVal.length === 4);
       } else {
           card.classList.add('hidden');
           btn.disabled = true;
       }
    }

    // Watch plate input
    document.getElementById('plateInput').addEventListener('input', function(e){
        const val = e.target.value;
        const btn = document.getElementById('btnStart');
        const isTaskValid = !document.getElementById('taskInfoCard').classList.contains('hidden');
        btn.disabled = !(isTaskValid && val.length === 4);
        document.getElementById('verifyError').classList.add('hidden');
    });

    function doVerify(){
      const input = document.getElementById('plateInput').value.toUpperCase();
      const exp = MOCK_DATA.plate.slice(-4);
      
      if(input !== exp){
        document.getElementById('verifyError').classList.remove('hidden');
        
        // Show Modal
        document.getElementById('modalExpPlate').textContent = MOCK_DATA.plate;
        document.getElementById('modalActPlate').textContent = input;
        document.getElementById('confirmModal').classList.remove('hidden');
        return;
      }
      
      // Success
      setState('unloading');
    }

    function confirmCheck() {
        document.getElementById('confirmModal').classList.add('hidden');
        setState('unloading');
        toastShow('开始卸车作业','success');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
    }

    function openOversizePanel() {
        document.getElementById('osTaskId').textContent = taskId;
        document.getElementById('osDoor').textContent = MOCK_DATA.door;
        document.getElementById('osPlate').textContent = MOCK_DATA.plate;
        
        const p = document.getElementById('oversizePanel');
        p.classList.remove('hidden');
        // Trigger reflow
        p.offsetHeight;
        p.firstElementChild.classList.remove('translate-y-full');
    }

    function closeOversizePanel() {
        const p = document.getElementById('oversizePanel');
        p.firstElementChild.classList.add('translate-y-full');
        setTimeout(() => p.classList.add('hidden'), 300);
    }

    function submitOversize() {
        const reason = document.getElementById('osReason').value;
        toastShow('大件监护申请已提交', 'success');
        closeOversizePanel();
    }

    function gotoFinish(){ setState('finished'); }
    function cancelFinish(){ setState('unloading'); }

    function renderRecords(){
      const raw = localStorage.getItem('unloadRecords:'+taskId);
      const arr = raw ? JSON.parse(raw) : [];
      const listEl = document.getElementById('recordsList');
      const emptyEl = document.getElementById('emptyState');
      
      if(arr.length===0){
        listEl.innerHTML = '';
        emptyEl.classList.remove('hidden');
        return;
      }
      emptyEl.classList.add('hidden');
      
      listEl.innerHTML = arr.map(r => {
        const isTray = r.record_type==='tray';
        const viewHref = 'operator-unloading-edit.html?task_id='+encodeURIComponent(taskId)+'&record_id='+(r.record_id||r.id)+'&readonly=true&from=task_detail';
        return `
          <div class="bg-white rounded-2xl shadow-sm p-4 border border-gray-50 active:bg-gray-50 transition-colors" onclick="window.location.href='${viewHref}'">
            <div class="flex items-start justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded text-xs font-medium ${isTray?'bg-indigo-50 text-indigo-600':'bg-emerald-50 text-emerald-600'}">
                  ${isTray?'整托':'散货'}
                </span>
                <span class="text-sm font-bold text-gray-800">#${(r.record_id||r.id).slice(-6)}</span>
              </div>
              <span class="text-xs text-gray-400">${r.create_time ? r.create_time.split('T')[1].slice(0,5) : '--:--'}</span>
            </div>
            <div class="text-xs text-gray-500 flex items-center gap-4">
              <div class="flex items-center gap-1"><i class="fas fa-box text-gray-300"></i> ${isTray ? (r.tray_number||'未录入') : (r.goods?.sku||'未录入')}</div>
              ${r.status==='done' ? '<div class="flex items-center gap-1 text-green-600"><i class="fas fa-check-circle"></i> 已完成</div>' : '<div class="flex items-center gap-1 text-orange-500"><i class="fas fa-clock"></i> 进行中</div>'}
            </div>
          </div>
        `;
      }).join('');
    }

    function updateProgress(){
      document.getElementById('topTaskId').textContent = taskId;
      const raw = localStorage.getItem('unloadRecords:'+taskId);
      const arr = raw?JSON.parse(raw):[];
      const trayTotal=arr.filter(r=>r.record_type==='tray').length;
      const looseTotal=arr.filter(r=>r.record_type==='loose').length;
      document.getElementById('topProgText').textContent = `整托 ${trayTotal} · 散货 ${looseTotal}`;
    }
    
    function renderFinishContent(){
      document.getElementById('finishCard').innerHTML = `
        <div class="text-center mb-6">
          <div class="w-16 h-16 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-3 text-green-600 text-2xl">
            <i class="fas fa-clipboard-check"></i>
          </div>
          <h3 class="text-lg font-bold text-gray-800">确认完成卸车</h3>
          <p class="text-gray-500 text-xs mt-1">请勾选以下项目以确认</p>
        </div>
        <div class="space-y-3">
          <label class="flex items-center p-3 bg-gray-50 rounded-xl border border-gray-100 cursor-pointer transition-colors hover:bg-gray-100">
            <input id="chkTray" type="checkbox" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 mr-3">
            <span class="text-sm text-gray-700">所有托盘货物已清点入库</span>
          </label>
          <label class="flex items-center p-3 bg-gray-50 rounded-xl border border-gray-100 cursor-pointer transition-colors hover:bg-gray-100">
            <input id="chkLoose" type="checkbox" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 mr-3">
            <span class="text-sm text-gray-700">所有散货已核对数量</span>
          </label>
          <label class="flex items-center p-3 bg-gray-50 rounded-xl border border-gray-100 cursor-pointer transition-colors hover:bg-gray-100">
            <input id="chkGuard" type="checkbox" class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300 mr-3">
            <span class="text-sm text-gray-700">如有大件/异常已妥善处理</span>
          </label>
        </div>
      `;
    }

    function bindFinishButton(){
      const updateEnable = () => {
        const ok = document.getElementById('btnConfirmFinish');
        const a = document.getElementById('chkTray')?.checked;
        const b = document.getElementById('chkLoose')?.checked;
        const c = document.getElementById('chkGuard')?.checked;
        if(ok) ok.disabled = !(a&&b&&c);
      };
      ['chkTray','chkLoose','chkGuard'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.onchange = updateEnable;
      });
      const btn = document.getElementById('btnConfirmFinish');
      if(btn){
        btn.onclick = function(){
          toastShow('已标记完成','ok');
          backDetail();
        };
      }
    }

    if(refresh){ updateProgress(); }
    applyState(getState());
  </script>
</body>
</html>
