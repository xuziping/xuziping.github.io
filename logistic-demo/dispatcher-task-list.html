<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>调度员 · 任务清单</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <script src="./simulator-layout.js"></script>
  <script src="./common.js"></script>
  <script>
    initSimulatorLayout({
      title: '任务清单 · 调度员',
      titleIcon: 'fas fa-list',
      role: 'dispatcher',
      activeNav: 'tasks',
      content: `
        <div class="flex flex-col h-full relative bg-gray-50">
          <div class="flex-none px-6 py-4 bg-white border-b border-gray-100 z-10">
            <div class="grid grid-cols-2 gap-2 mb-3">
              <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                <input id="search" class="w-full pl-8 pr-3 py-2.5 bg-gray-50 border border-gray-100 rounded-xl text-sm focus:outline-none focus:bg-white focus:ring-2 focus:ring-indigo-500 transition-all" placeholder="搜索任务号/车牌" />
              </div>
              <div id="sortTrigger" class="px-3 py-2.5 bg-gray-50 border border-gray-100 rounded-xl text-sm text-gray-600 flex items-center justify-between cursor-pointer active:scale-[0.98] transition-transform">
                <span id="sortText">按时间顺序</span>
                <i class="fas fa-chevron-down text-gray-400 text-xs"></i>
              </div>
            </div>
            <div class="flex items-center gap-1 p-1 bg-gray-100/80 rounded-xl">
              <button id="tabPending" class="flex-1 py-2 rounded-lg text-xs font-medium transition-all shadow-sm bg-white text-indigo-600">待我处理</button>
              <button id="tabQueue" class="flex-1 py-2 rounded-lg text-xs font-medium transition-all text-gray-500 hover:text-gray-700">他人处理</button>
              <button id="tabDone" class="flex-1 py-2 rounded-lg text-xs font-medium transition-all text-gray-500 hover:text-gray-700">已完成</button>
            </div>
          </div>

          <div id="list" class="flex-1 overflow-y-auto p-4 pb-28 space-y-3 scrollbar-hide"></div>
        </div>
      `
    });
  </script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const initialFilter = urlParams.get('filter') || 'pending';
    let currentFilter = initialFilter;
    let currentSort = 'time';
    let appData = null;
    let tasks = [];
    let doors = [];

    function loadData(){ if(appData) return Promise.resolve(appData); const url = new URL('app-data.json', document.baseURI).href; if(location.protocol==='file:'){ appData = (window.APP_DATA_FALLBACK||{}); return Promise.resolve(appData); } return fetch(url).then(r=>{ if(!r.ok) throw new Error('fail'); return r.json(); }).then(d=>{ appData=d; return d; }).catch(()=>{ appData = (window.APP_DATA_FALLBACK||{}); return appData; }); }

    const sortOptions = [
        { value: 'time', label: '按时间顺序' },
        { value: 'category', label: '按任务类别' }
    ];
    const sortPanel = window.createSelectionPanel({
        id: 'sortPanel',
        title: '排序方式',
        confirmText: '确认',
        onConfirm: function(val){
            if(!val) return;
            currentSort = val;
            const label = sortOptions.find(o=>o.value===val)?.label || val;
            document.getElementById('sortText').textContent = label;
            sortPanel.close();
            render();
        }
    });
    document.getElementById('sortTrigger').onclick = function(){
        sortPanel.open(sortOptions, currentSort);
    };

    function setActiveTabs(){
      const tabs = ['tabPending', 'tabQueue', 'tabDone'];
      const filters = ['pending', 'queue', 'completed'];
      const labels = ['待我处理', '他人处理中', '已完成']; // Renaming tabs to match unified request
      
      tabs.forEach((id, idx) => {
        const el = document.getElementById(id);
        el.textContent = labels[idx]; // Update text
        if(currentFilter === filters[idx]){
          el.className = 'flex-1 py-2 rounded-lg text-xs font-bold transition-all shadow-sm bg-white text-indigo-600';
        } else {
          el.className = 'flex-1 py-2 rounded-lg text-xs font-medium transition-all text-gray-500 hover:text-gray-700';
        }
      });
    }

    document.getElementById('tabPending').onclick = ()=>{ currentFilter='pending'; setActiveTabs(); render(); };
    document.getElementById('tabQueue').onclick = ()=>{ currentFilter='queue'; setActiveTabs(); render(); };
    document.getElementById('tabDone').onclick = ()=>{ currentFilter='completed'; setActiveTabs(); render(); };
    document.getElementById('search').oninput = render;

    function labelOf(status){ 
        if(status==='pending') return '待分配'; 
        if(status==='queue') return '队列中'; 
        if(status==='working') return '作业中';
        if(status==='completed') return '已完成';
        if(status==='cancelled') return '已取消';
        return status; 
    }

    function goDetail(id){ window.location.href = 'dispatcher-task-detail.html?task_id=' + encodeURIComponent(id); }

    let dispatchTargetId = '';
    let dispatchPanel = window.createSelectionPanel({
        id: 'dispatchPanel',
        title: '选择库门',
        confirmText: '确认分配',
        onConfirm: function(val){
            if(!val){ toastShow('请选择库门'); return; }
            dispatchPanel.close();
            const t = tasks.find(x=>x.id===dispatchTargetId);
            if(t){ 
                t.door = val; 
                if(t.status === 'pending') t.status = 'queue';
                toastShow(`任务 ${t.id} 已分配至 ${val}`, 'ok'); 
                render(); 
            }
        }
    });

    function openDispatchPanel(e, id){ 
        e.stopPropagation();
        dispatchTargetId = id;
        const validDoors = doors.filter(d => d.status !== 'paused' && d.status !== 'limited');
        const items = validDoors.map(d => ({
             value: d.id,
             label: `库门 ${d.id} · ${d.queue}车排队 · ${d.status==='working'?'作业中':'空闲'}`
        }));
        dispatchPanel.open(items);
    }

    function render(){
      loadData().then(()=>{
        tasks = appData.inboundTasks || [];
        doors = appData.doors || [];
        const search = document.getElementById('search').value.trim().toLowerCase();
        
        let filtered = tasks.filter(t => {
          if(currentFilter === 'pending') return t.status === 'pending';
          if(currentFilter === 'queue') return ['queue', 'working', 'paused', 'limited'].includes(t.status);
          return ['completed', 'cancelled'].includes(t.status);
        });

        if(search){ 
          filtered = filtered.filter(t=> (t.id||'').toLowerCase().includes(search) || (t.plate||t.prePlate||'').toLowerCase().includes(search)); 
        }

        if(currentSort==='time'){
            // Mock creation time if missing
            filtered.sort((a,b)=> (b.wait||0) - (a.wait||0)); // Using wait time as proxy for age if timestamps missing
        } else {
            filtered.sort((a,b)=> (a.packType||'').localeCompare(b.packType||'') || (b.wait||0) - (a.wait||0));
        }

        const list = document.getElementById('list');
        list.innerHTML = '';

        if(filtered.length===0){ 
          list.innerHTML = `<div class='flex flex-col items-center justify-center py-12 text-gray-400'><i class="fas fa-clipboard-list text-4xl mb-3 opacity-20"></i><div class="text-xs">暂无相关任务</div></div>`; 
          return; 
        }
        
        filtered.forEach(t=>{
          const item = document.createElement('div');
          item.className = 'bg-white rounded-2xl p-4 shadow-sm border border-gray-100 active:scale-[0.99] transition-transform cursor-pointer relative overflow-hidden';
          item.onclick = () => goDetail(t.id);

          const diffSeconds = (t.wait || 0) * 60; // Convert mins to seconds
          const waitText = window.formatDurationSmart ? window.formatDurationSmart(diffSeconds) : t.wait + ' min';

          // Status Badge
          let statusColor = 'bg-gray-100 text-gray-600';
          if(t.status==='completed') statusColor = 'bg-green-50 text-green-600';
          else if(t.status==='pending') statusColor = 'bg-yellow-50 text-yellow-600';
          else if(['queue','working'].includes(t.status)) statusColor = 'bg-blue-50 text-blue-600';

          const isOversize = (t.packType==='oversize'||(t.cargo&&t.cargo.weight>1000));
          
          // Row 3 Content (Only for Waiting Me - which maps to pending here)
          let row3 = '';
          if(currentFilter === 'pending'){
            const isAssigned = t.door && t.door !== '-' && t.door !== '--';
            const btnText = isAssigned ? '更改库门' : '分配库门';
            row3 = `
              <div class="flex items-center justify-between pt-3 mt-3 border-t border-gray-50">
                <div class="flex items-center text-xs text-gray-500 font-medium">
                  <i class="fas fa-stopwatch mr-1.5 text-indigo-400"></i>等待 ${waitText}
                </div>
                <button class="px-4 py-1.5 rounded-lg bg-indigo-600 text-white text-xs font-bold shadow-sm shadow-indigo-200 active:scale-95 transition-transform" onclick="openDispatchPanel(event, '${t.id}')">
                  ${btnText}
                </button>
              </div>
            `;
          }

          item.innerHTML = `
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <span class="px-2 py-0.5 rounded text-[10px] font-bold bg-blue-50 text-blue-600">进仓</span>
                <span class="font-bold text-gray-800 text-sm tracking-tight">${t.id}</span>
                ${isOversize ? '<i class="fas fa-box text-orange-500 text-xs" title="大件"></i>' : ''}
              </div>
              <span class="${statusColor.replace('bg-','text-').split(' ')[1]} text-xs font-bold">${labelOf(t.status)}</span>
            </div>
            
            <div class="grid grid-cols-2 gap-2 text-xs text-gray-500 mb-1">
              <div class="flex items-center"><i class="fas fa-door-open w-4 text-center mr-1.5 text-gray-300"></i><span class="text-gray-700 font-medium">${(!t.door || t.door==='-') ? '待分配' : t.door}</span></div>
              <div class="flex items-center"><i class="fas fa-truck w-4 text-center mr-1.5 text-gray-300"></i><span class="text-gray-700 font-medium truncate">${t.plate||t.prePlate||'--'}</span></div>
            </div>

            ${row3}
          `;
          list.appendChild(item);
        });
      });
    }

    setActiveTabs();
    render();
  </script>
</body>
</html>